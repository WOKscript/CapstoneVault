{% extends 'core/base.html' %}
{% load static %}

{% block content %}

  <style>
    :root { --ctl-h: 36px; }
    .toolbar { gap:.5rem; }
    .toolbar .form-control,
    .toolbar .form-select,
    .toolbar .btn {
      height: var(--ctl-h);
      padding-top:.25rem; padding-bottom:.25rem;
    }
    .w-md-260 { width:100%; }
    .w-md-180 { width:100%; }
    @media (min-width: 768px) {
      .w-md-260 { width:260px; }
      .w-md-180 { width:180px; }
    }
    .muted { color: rgba(0,0,0,.6); }
    .chip { background:#f8f9fa; border:1px solid #e9ecef; border-radius:9999px; padding:.2rem .6rem; font-size:.75rem; }
    .card-clean { border:0; box-shadow:0 .25rem .75rem rgba(0,0,0,.06); transition:transform .06s ease, box-shadow .2s ease; }
    .card-clean:hover { transform:translateY(-2px); box-shadow:0 .6rem 1.2rem rgba(0,0,0,.09); }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .tag { font-size:.75rem; background:#eef2f6; color:#1f2a37; }
    .tag-wrap { max-height:56px; overflow:auto; }
    .card-footer { background:transparent; border-top:0; }

    .actions { gap:.5rem; white-space:nowrap; width:100%; }
    .actions .btn-fill {
      flex: 1 1 auto;
      min-width: 0;
    }
  </style>

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-end mb-2">
    <h3 class="mb-0">{{ category.name }} Capstones</h3>
    {% if papers %}<span class="muted small">{{ papers|length }} result{{ papers|length|pluralize }}</span>{% endif %}
  </div>

  <!-- Breadcrumb + Toolbar -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <nav aria-label="breadcrumb" class="mb-2 mb-md-0">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'capstones_main' %}">Capstones</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ category.name }}</li>
      </ol>
    </nav>

    <form method="get" class="toolbar d-flex flex-wrap justify-content-end">
      {% if selected_year %}<input type="hidden" name="year" value="{{ selected_year }}">{% endif %}
      {% if selected_subcategory %}<input type="hidden" name="subcategory" value="{{ selected_subcategory }}">{% endif %}

      <input type="text" name="q" value="{{ search_query }}"
             class="form-control form-control-sm w-md-260"
             placeholder="Search papers by title, author, or tag">

      <select name="sort" class="form-select form-select-sm w-md-180">
        <option value="">Sort</option>
        <option value="year_desc" {% if request.GET.sort == 'year_desc' %}selected{% endif %}>Year (newest)</option>
        <option value="year_asc" {% if request.GET.sort == 'year_asc' %}selected{% endif %}>Year (oldest)</option>
        <option value="title_asc" {% if request.GET.sort == 'title_asc' %}selected{% endif %}>Title (A–Z)</option>
      </select>

      <button type="submit" class="btn btn-primary btn-sm">Search</button>
      <button type="button" class="btn btn-outline-secondary btn-sm"
              data-bs-toggle="modal" data-bs-target="#filterModal">
        Filter
      </button>
    </form>
  </div>

  {% if selected_year or selected_subcategory %}
    <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
      {% if selected_year %}<span class="chip">Year: {{ selected_year }}</span>{% endif %}
      {% if selected_subcategory %}<span class="chip">Subcategory: {{ selected_subcategory }}</span>{% endif %}
      <a href="{% url 'capstones_by_category' category.slug %}" class="small text-decoration-none">Reset</a>
    </div>
  {% endif %}

  {% if papers %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for paper in papers %}
        <div class="col">
          <div class="card card-clean h-100">
            <div class="card-body d-flex flex-column">
              <h6 class="mb-1 line-clamp-2">{{ paper.title }}</h6>
              <div class="muted small mb-2">
                {{ paper.publication_year }} • {{ paper.category.name }} / {{ paper.subcategory.name }}
              </div>
              <div class="muted small mb-3">
                Authors: {{ paper.authors }}{% if paper.adviser %} • Adviser: {{ paper.adviser }}{% endif %}
              </div>
              {% if paper.tags.all %}
                <div class="tag-wrap d-flex flex-wrap gap-1 mt-auto">
                  {% for tag in paper.tags.all %}
                    <span class="badge tag">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="card-footer">
              <div class="actions d-flex align-items-stretch flex-nowrap">

                {% if request.user.userprofile.role == 'admin' %}
                  <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm btn-fill" target="_blank">View PDF</a>
                  <a href="{% url 'edit_paper' paper.id %}" class="btn btn-outline-warning btn-sm">Edit</a>
                  <button type="button" class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal" data-bs-target="#delModal{{ paper.id }}">Delete</button>

                {% elif request.user.userprofile.role == 'verified' and request.user == paper.uploaded_by %}
                  <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm btn-fill" target="_blank">View PDF</a>
                  <a href="{% url 'edit_paper' paper.id %}" class="btn btn-outline-warning btn-sm">Edit</a>
                  <button type="button" class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal" data-bs-target="#delModal{{ paper.id }}">Delete</button>

                {% elif request.user.userprofile.role == 'verified' %}
                  <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm btn-fill" target="_blank">View PDF</a>
                  <button type="button" class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal" data-bs-target="#infoModal{{ paper.id }}">Info</button>

                {% else %}
                  {% if paper.id in approved_access_ids %}
                    <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm btn-fill" target="_blank">View PDF</a>
                  {% else %}
                    <a href="{% url 'request_access' paper.id %}" class="btn btn-warning btn-sm btn-fill">Request Access</a>
                  {% endif %}
                  <button type="button" class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal" data-bs-target="#infoModal{{ paper.id }}">Info</button>
                {% endif %}

              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <h6 class="mb-1">No papers found</h6>
      <p class="muted mb-3">Try adjusting your search or filters.</p>
    </div>
  {% endif %}

{% endblock %}
