{% extends 'core/base.html' %}
{% load static %}

{% block content %}

  <style>
    :root { --ctl-h: 36px; }
    .toolbar { gap:.5rem; }
    .toolbar .form-control,
    .toolbar .form-select,
    .toolbar .btn {
      height: var(--ctl-h);
      padding-top:.25rem; padding-bottom:.25rem;
    }
    .w-md-260 { width:100%; }
    .w-md-180 { width:100%; }
    @media (min-width: 768px) {
      .w-md-260 { width:260px; }
      .w-md-180 { width:180px; }
    }
    .muted { color: rgba(0,0,0,.6); }
    .chip { background:#f8f9fa; border:1px solid #e9ecef; border-radius:9999px; padding:.2rem .6rem; font-size:.75rem; }
    .card-clean { border:0; box-shadow:0 .25rem .75rem rgba(0,0,0,.06); transition:transform .06s ease, box-shadow .2s ease; }
    .card-clean:hover { transform:translateY(-2px); box-shadow:0 .6rem 1.2rem rgba(0,0,0,.09); }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .tag { font-size:.75rem; background:#eef2f6; color:#1f2a37; }
    .tag-wrap { max-height:56px; overflow:auto; }
    .card-footer { background:transparent; border-top:0; }

    .actions { gap:.5rem; white-space:nowrap; }
    .actions .btn { min-width: 86px; }
  </style>

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-end mb-2">
    <h3 class="mb-0">{{ category.name }} Capstones</h3>
    {% if papers %}<span class="muted small">{{ papers|length }} result{{ papers|length|pluralize }}</span>{% endif %}
  </div>

  <!-- Breadcrumb + Toolbar -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <nav aria-label="breadcrumb" class="mb-2 mb-md-0">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'capstones_main' %}">Capstones</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ category.name }}</li>
      </ol>
    </nav>

    <form method="get" class="toolbar d-flex flex-wrap justify-content-end">
      {% if selected_year %}<input type="hidden" name="year" value="{{ selected_year }}">{% endif %}
      {% if selected_subcategory %}<input type="hidden" name="subcategory" value="{{ selected_subcategory }}">{% endif %}

      <input type="text" name="q" value="{{ search_query }}"
             class="form-control form-control-sm w-md-260"
             placeholder="Search papers by title, author, or tag">

      <select name="sort" class="form-select form-select-sm w-md-180">
        <option value="">Sort</option>
        <option value="year_desc" {% if request.GET.sort == 'year_desc' %}selected{% endif %}>Year (newest)</option>
        <option value="year_asc" {% if request.GET.sort == 'year_asc' %}selected{% endif %}>Year (oldest)</option>
        <option value="title_asc" {% if request.GET.sort == 'title_asc' %}selected{% endif %}>Title (A–Z)</option>
      </select>

      <button type="submit" class="btn btn-primary btn-sm">Search</button>
      <button type="button" class="btn btn-outline-secondary btn-sm"
              data-bs-toggle="modal" data-bs-target="#filterModal">
        Filter
      </button>
    </form>
  </div>

  {% if selected_year or selected_subcategory %}
    <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
      {% if selected_year %}<span class="chip">Year: {{ selected_year }}</span>{% endif %}
      {% if selected_subcategory %}<span class="chip">Subcategory: {{ selected_subcategory }}</span>{% endif %}
      <a href="{% url 'capstones_by_category' category.slug %}" class="small text-decoration-none">Reset</a>
    </div>
  {% endif %}

  <!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Filters</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="get">
            <input type="hidden" name="q" value="{{ search_query }}">
            <input type="hidden" name="sort" value="{{ request.GET.sort }}">
            <div class="mb-3">
              <label for="yearFilter" class="form-label">Year</label>
              <select id="yearFilter" name="year" class="form-select form-select-sm">
                <option value="">All Years</option>
                {% for y in years %}
                  <option value="{{ y }}" {% if y|stringformat:"s" == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="subcatFilter" class="form-label">Subcategory</label>
              <select id="subcatFilter" name="subcategory" class="form-select form-select-sm">
                <option value="">All Subcategories</option>
                {% for sub in subcategories %}
                  <option value="{{ sub }}" {% if sub == selected_subcategory %}selected{% endif %}>{{ sub }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success btn-sm">Apply</button>
            </div>
            <div class="mt-2 text-center">
              <a href="{% url 'capstones_by_category' category.slug %}">Reset All Filters</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% if papers %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for paper in papers %}
        <div class="col">
          <div class="card card-clean h-100">
            <div class="card-body d-flex flex-column">
              <h6 class="mb-1 line-clamp-2">{{ paper.title }}</h6>
              <div class="muted small mb-2">
                {{ paper.publication_year }} • {{ paper.category.name }} / {{ paper.subcategory.name }}
              </div>
              <div class="muted small mb-3">
                Authors: {{ paper.authors }}{% if paper.adviser %} • Adviser: {{ paper.adviser }}{% endif %}
              </div>
              {% if paper.tags.all %}
                <div class="tag-wrap d-flex flex-wrap gap-1 mt-auto">
                  {% for tag in paper.tags.all %}
                    <span class="badge tag">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="card-footer">
              <div class="actions d-flex align-items-stretch flex-nowrap">

                {% if request.user.userprofile.role == 'admin' %}
                  <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm" target="_blank" rel="noopener noreferrer">View PDF</a>
                  <a href="{% url 'edit_paper' paper.id %}" class="btn btn-outline-warning btn-sm">Edit</a>
                  <button type="button" class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal" data-bs-target="#delModal{{ paper.id }}">Delete</button>

                {% elif request.user.userprofile.role == 'verified' and request.user == paper.uploaded_by %}
                  <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm" target="_blank" rel="noopener noreferrer">View PDF</a>
                  <a href="{% url 'edit_paper' paper.id %}" class="btn btn-outline-warning btn-sm">Edit</a>
                  <button type="button" class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal" data-bs-target="#delModal{{ paper.id }}">Delete</button>

                {% elif request.user.userprofile.role == 'verified' %}
                  <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm" target="_blank" rel="noopener noreferrer">View PDF</a>
                  <button type="button" class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal" data-bs-target="#infoModal{{ paper.id }}">Info</button>

                {% else %}
                  {% if paper.id in approved_access_ids %}
                    <a href="{% url 'view_paper' paper.id %}" class="btn btn-primary btn-sm" target="_blank" rel="noopener noreferrer">View PDF</a>
                  {% else %}
                    <a href="{% url 'request_access' paper.id %}" class="btn btn-warning btn-sm">Request Access</a>
                  {% endif %}
                  <button type="button" class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal" data-bs-target="#infoModal{{ paper.id }}">Info</button>
                {% endif %}

              </div>
            </div>
          </div>
        </div>

        <!-- Info Modal -->
        <div class="modal fade" id="infoModal{{ paper.id }}" tabindex="-1"
             aria-labelledby="infoModalLabel{{ paper.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel{{ paper.id }}">{{ paper.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="mb-1"><strong>Abstract</strong></p>
                <p style="text-align: justify; text-justify: inter-word;">{{ paper.abstract }}</p>
                <hr class="my-3">
                <div class="row g-2 small">
                  <div class="col-12 col-md-6"><strong>Authors:</strong> {{ paper.authors }}</div>
                  <div class="col-12 col-md-6">{% if paper.adviser %}<strong>Adviser:</strong> {{ paper.adviser }}{% endif %}</div>
                  <div class="col-12 col-md-6"><strong>Year:</strong> {{ paper.publication_year }}</div>
                  <div class="col-12 col-md-6"><strong>Category:</strong> {{ paper.category.name }}</div>
                  <div class="col-12">
                    <strong>Tags:</strong>
                    {% for tag in paper.tags.all %}
                      <span class="badge tag">{{ tag.name }}</span>
                    {% empty %}
                      <span class="muted">None</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        {% if request.user.userprofile.role == 'admin' %}
        <!-- Delete Confirmation Modal (Admin) -->
        <div class="modal fade" id="delModal{{ paper.id }}" tabindex="-1" aria-labelledby="delModalLabel{{ paper.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="delModalLabel{{ paper.id }}">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to permanently delete "<strong>{{ paper.title }}</strong>"?
                <div class="small text-muted mt-2">This action cannot be undone.</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_paper' paper.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm">Yes, delete</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if request.user.userprofile.role == 'verified' and request.user == paper.uploaded_by %}
        <!-- Delete Confirmation Modal (Verified Owner) -->
        <div class="modal fade" id="delModal{{ paper.id }}" tabindex="-1" aria-labelledby="delModalLabel{{ paper.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="delModalLabel{{ paper.id }}">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to permanently delete "<strong>{{ paper.title }}</strong>"?
                <div class="small text-muted mt-2">This action cannot be undone.</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_paper' paper.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm">Yes, delete</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <div class="mb-2">
        <svg width="56" height="56" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" opacity=".12" d="M5 4h14a1 1 0 0 1 1 1v12H4V5a1 1 0 0 1 1-1z"/>
          <path fill="currentColor" d="M3 20h18v1a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1z"/>
        </svg>
      </div>
      <h6 class="mb-1">No papers found</h6>
      <p class="muted mb-3">Try adjusting your search or filters.</p>
      <a href="{% url 'capstones_by_category' category.slug %}" class="btn btn-outline-primary btn-sm">Reset Filters</a>
    </div>
  {% endif %}

{% endblock %}
