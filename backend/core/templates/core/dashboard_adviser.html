{% extends 'core/base.html' %}
{% block content %}
<h3 class="mb-4">Welcome, Adviser</h3>

<div class="row g-3 mb-4">
  <!-- Pending -->
  <div class="col-md-4">
    <div class="card bg-warning text-dark shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Pending Papers</h5>
        <h3>{{ pending_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Approved -->
  <div class="col-md-4">
    <div class="card bg-success text-white shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Approved Papers</h5>
        <h3>{{ approved_count }}</h3>
      </div>
    </div>
  </div>

  <!-- For Revision -->
  <div class="col-md-4">
    <div class="card bg-orange text-white shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Papers for Revision</h5>
        <h3>{{ revise_count }}</h3>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Recent Submissions</h5>
    {% if recent_papers %}
      <ul class="list-group">
        {% for paper in recent_papers %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ paper.title }}
            {% if paper.status == 'pending' %}
              <span class="badge bg-warning text-dark">{{ paper.status }}</span>
            {% elif paper.status == 'approved' %}
              <span class="badge bg-success">{{ paper.status }}</span>
            {% elif paper.status == 'revise' or paper.status == 'revision' %}
              <span class="badge bg-orange">{{ paper.status }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ paper.status }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No recent uploads.</p>
    {% endif %}
  </div>
</div>

<!-- Mini Trend Visualization -->
<style>
  .mini-chart { min-height: 180px; }
  .card-link { color: inherit; text-decoration: none; }
  .card-link .card:hover { box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1); }
</style>

<div class="row g-3">
  <!-- Yearly Output -->
  <div class="col-md-4">
    <a href="{% url 'trends_dashboard' %}" class="card-link">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title d-flex justify-content-between align-items-center">
            Yearly Output
            <span class="small text-muted">view details →</span>
          </h6>
          <div id="miniYearly" class="mini-chart"></div>
        </div>
      </div>
    </a>
  </div>

  <!-- Category Trend -->
  <div class="col-md-4">
    <a href="{% url 'trends_dashboard' %}" class="card-link">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title d-flex justify-content-between align-items-center">
            Category Trend
            <span class="small text-muted">view details →</span>
          </h6>
          <div id="miniCategory" class="mini-chart"></div>
        </div>
      </div>
    </a>
  </div>

  <!-- Most Accessed Papers (by School Year) -->
  <div class="col-md-4">
    <a href="{% url 'trends_dashboard' %}" class="card-link">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-title d-flex justify-content-between align-items-center">
            Most Accessed Papers
            <small id="miniAyLabel" class="text-muted"></small>
          </h6>
          <div id="miniMostAccessed" class="mini-chart"></div>
        </div>
      </div>
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
(function () {
  // ---- helpers ----
  async function fetchJSON(url) {
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }
  const AY_START_MONTH = 8;
  function ayFor(d) {
    const y = d.getFullYear(), m = d.getMonth() + 1;
    return (m >= AY_START_MONTH) ? `${y}-${y+1}` : `${y-1}-${y}`;
  }

  // Elements
  const elMiniYearly   = document.querySelector('#miniYearly');
  const elMiniCategory = document.querySelector('#miniCategory');
  const elMiniMostAcc  = document.querySelector('#miniMostAccessed');
  const elAyLabel      = document.querySelector('#miniAyLabel');

  // ---- Yearly + Category (from trends_api) ----
  fetchJSON("{% url 'trends_api' %}")
    .then(data => {
      // Yearly donut: uses yearly.counts + yearly.labels
      new ApexCharts(elMiniYearly, {
        chart: { type: 'donut', height: 180, sparkline: { enabled: true } },
        series: data.yearly.counts,
        labels: data.yearly.labels,
        legend: { show: false },
        dataLabels: { enabled: false },
        tooltip: { y: { formatter: v => v } }
      }).render();

      // Category line: uses stackedByCategory.series + labels
      new ApexCharts(elMiniCategory, {
        chart: { type: 'line', height: 180, sparkline: { enabled: true } },
        series: data.stackedByCategory.series.map(s => ({ name: s.name, data: s.data })),
        xaxis: { categories: data.stackedByCategory.labels },
        stroke: { curve: 'smooth', width: 2 },
        markers: { size: 0 },
        dataLabels: { enabled: false },
        tooltip: { y: { formatter: v => v } }
      }).render();
    })
    .catch(err => console.error('trends_api error:', err));

  // ---- Most Accessed (from most_accessed_api) with AY fallback ----
  const currentAY = ayFor(new Date());
  const ayCandidates = Array.from({length: 5}, (_, i) => {
    const base = parseInt(currentAY.slice(0,4)) - i;
    return `${base}-${base+1}`;
  });

  async function renderMostAccessed(ay) {
    const d = await fetchJSON("{% url 'most_accessed_api' %}?ay=" + encodeURIComponent(ay));
    const papers = d.topPapers || [];
    if (!papers.length) return false;

    const labels = papers.map(p => p.title.length > 22 ? p.title.slice(0,22) + '…' : p.title);
    const views  = papers.map(p => p.views);
    elMiniMostAcc.innerHTML = '';

    new ApexCharts(elMiniMostAcc, {
      chart: { type: 'bar', height: 180, sparkline: { enabled: true } },
      series: [{ name: 'Views', data: views }],
      xaxis: { categories: labels },
      plotOptions: { bar: { horizontal: true, barHeight: '70%' } },
      dataLabels: { enabled: false },
      tooltip: {
        y: { formatter: v => v },
        x: { formatter: (val, ctx) => papers[ctx.dataPointIndex]?.title || val }
      }
    }).render();

    if (elAyLabel) elAyLabel.textContent = ay;
    return true;
  }

  (async () => {
    let ok = false;
    for (const ay of ayCandidates) {
      try {
        ok = await renderMostAccessed(ay);
        if (ok) break;
      } catch (e) {
        console.error('most_accessed_api error for', ay, e);
      }
    }
    if (!ok) {
      elAyLabel.textContent = currentAY;
      elMiniMostAcc.innerHTML = '<div class="text-muted small">No views recorded yet.</div>';
    }
  })();
})();
</script>
{% endblock %}
