{% extends 'core/base.html' %}
{% block content %}
<div class="container-fluid px-4">
  <h3 class="mb-4">Welcome, Verified User</h3>

  {% if can_upload %}
    <div class="alert alert-success">You have permission to upload capstone papers.</div>
    <a href="{% url 'upload_capstone' %}" class="btn btn-primary mb-4">Upload Capstone Paper</a>
  {% else %}
    <div class="alert alert-warning">Your adviser hasn’t granted upload permission or you already have a pending/revise paper.</div>
  {% endif %}

  <a href="{% url 'capstones_main' %}" class="btn btn-success mb-4">Browse Capstone Repository</a>

  <!-- For Revision -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-orange text-white"><strong>For Revision</strong></div>
    <div class="card-body">
      {% if revised_papers %}
        <div class="revise-table-wrap">
          <table class="table table-bordered table-sm revise-table mb-0">
            <thead class="table-light">
              <tr>
                <th class="revise-col-title">Title</th>
                <th class="revise-col-feedback">Feedback</th>
                <th class="revise-col-uploaded">Uploaded At</th>
                <th class="revise-col-actions text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for paper in revised_papers %}
              <tr>
                <td class="title-cell"><span class="fw-semibold">{{ paper.title }}</span></td>
                <td>{{ paper.feedback|default:"—" }}</td>
                <td>{{ paper.uploaded_at|date:"M d, Y - H:i" }}</td>
                <td class="actions">
                  <a href="{% url 'edit_paper' paper.id %}" class="btn btn-primary btn-action">
                    <i class="bi bi-pencil-square"></i><span>Edit</span>
                  </a>
                  <form action="{% url 'cancel_revision' paper.id %}" method="post" class="m-0 d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-action"
                            onclick="return confirm('Cancel this upload/revision? This will remove the paper from your list.');">
                      <i class="bi bi-x-lg"></i><span>Cancel</span>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">You have no papers marked for revision.</p>
      {% endif %}
    </div>
  </div>

  <!-- Recent Access Requests -->
  <div class="card shadow-sm">
    <div class="card-header bg-light"><strong>Recent Access Requests</strong></div>
    <div class="card-body">
      {% if recent_requests %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Title</th><th>Status</th><th>Requested At</th></tr>
            </thead>
            <tbody>
              {% for req in recent_requests %}
              <tr>
                <td>{{ req.paper.title }}</td>
                <td>
                  {% if req.status == 'approved' %}
                    <span class="badge bg-success">Approved</span>
                  {% else %}
                    <span class="badge bg-secondary">Pending</span>
                  {% endif %}
                </td>
                <td>{{ req.requested_at|date:"M d, Y - H:i" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No access requests submitted yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Styles scoped to this page -->
  <style>
    /* Table layout */
    .revise-table-wrap { border-radius: .5rem; overflow-x: auto; }
    .revise-table { table-layout: auto; width: 100%; }
    .revise-table th, .revise-table td { vertical-align: middle; white-space: normal; }

    .revise-col-title    { min-width: 240px; }
    .revise-col-feedback { width: 14%; }
    .revise-col-uploaded { width: 16%; }
    .revise-col-actions  { min-width: 220px; padding: .5rem .75rem !important; }

    .title-cell { word-break: break-word; line-height: 1.25; }
    .title-cell .fw-semibold { font-weight: 600; }

    /* Actions: equal size, on one line */
    .actions {
      display: flex;
      flex-wrap: nowrap;          /* no stacking */
      gap: .5rem;
      justify-content: center;
      align-items: center;
    }
    .actions .btn-action {
      flex: 0 0 auto;             /* fixed-size buttons */
      height: 38px;
      min-width: 100px;           /* equal width; adjust if needed */
      padding: 0 .9rem;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .45rem;
      font-weight: 600;
      line-height: 1;
    }
    .actions i { font-size: 1rem; line-height: 0; }

    /* Mini charts styling */
    .mini-chart { min-height: 180px; }
    .card-link { color: inherit; text-decoration: none; }
    .card-link .card:hover { box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1); }
  </style>

  <!-- Mini Trend Visualization -->
  <div class="row g-3 mt-4">
    <div class="col-md-4">
      <a href="{% url 'trends_dashboard' %}" class="card-link">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title d-flex justify-content-between align-items-center">
              Yearly Output
              <span class="small text-muted">view details →</span>
            </h6>
            <div id="miniYearly" class="mini-chart"></div>
          </div>
        </div>
      </a>
    </div>
    <div class="col-md-4">
      <a href="{% url 'trends_dashboard' %}" class="card-link">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title d-flex justify-content-between align-items-center">
              Category Trend
              <span class="small text-muted">view details →</span>
            </h6>
            <div id="miniCategory" class="mini-chart"></div>
          </div>
        </div>
      </a>
    </div>
    <div class="col-md-4">
      <a href="{% url 'trends_dashboard' %}" class="card-link">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title d-flex justify-content-between align-items-center">
              Most Accessed Papers
              <small id="miniAyLabel" class="text-muted"></small>
            </h6>
            <div id="miniMostAccessed" class="mini-chart"></div>
          </div>
        </div>
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
(function () {
  async function fetchJSON(url) {
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }
  const AY_START_MONTH = 8;
  function ayFor(d) {
    const y = d.getFullYear(), m = d.getMonth() + 1;
    return (m >= AY_START_MONTH) ? `${y}-${y+1}` : `${y-1}-${y}`;
  }

  const elMiniYearly   = document.querySelector('#miniYearly');
  const elMiniCategory = document.querySelector('#miniCategory');
  const elMiniMostAcc  = document.querySelector('#miniMostAccessed');
  const elAyLabel      = document.querySelector('#miniAyLabel');

  fetchJSON("{% url 'trends_api' %}")
    .then(data => {
      new ApexCharts(elMiniYearly, {
        chart: { type: 'donut', height: 180, sparkline: { enabled: true } },
        series: data.yearly.counts,
        labels: data.yearly.labels,
        legend: { show: false },
        dataLabels: { enabled: false }
      }).render();

      new ApexCharts(elMiniCategory, {
        chart: { type: 'line', height: 180, sparkline: { enabled: true } },
        series: data.stackedByCategory.series.map(s => ({ name: s.name, data: s.data })),
        xaxis: { categories: data.stackedByCategory.labels },
        stroke: { curve: 'smooth', width: 2 },
        markers: { size: 0 },
        dataLabels: { enabled: false }
      }).render();
    });

  const currentAY = ayFor(new Date());
  const ayCandidates = Array.from({length: 5}, (_, i) => {
    const base = parseInt(currentAY.slice(0,4)) - i;
    return `${base}-${base+1}`;
  });

  async function renderMostAccessed(ay) {
    const d = await fetchJSON("{% url 'most_accessed_api' %}?ay=" + encodeURIComponent(ay));
    const papers = d.topPapers || [];
    if (!papers.length) return false;

    const labels = papers.map(p => p.title.length > 22 ? p.title.slice(0,22) + '…' : p.title);
    const views  = papers.map(p => p.views);
    elMiniMostAcc.innerHTML = '';

    new ApexCharts(elMiniMostAcc, {
      chart: { type: 'bar', height: 180, sparkline: { enabled: true } },
      series: [{ name: 'Views', data: views }],
      xaxis: { categories: labels },
      plotOptions: { bar: { horizontal: true, barHeight: '70%' } },
      dataLabels: { enabled: false }
    }).render();

    if (elAyLabel) elAyLabel.textContent = ay;
    return true;
  }

  (async () => {
    let ok = false;
    for (const ay of ayCandidates) {
      try {
        ok = await renderMostAccessed(ay);
        if (ok) break;
      } catch {}
    }
    if (!ok) {
      elAyLabel.textContent = currentAY;
      elMiniMostAcc.innerHTML = '<div class="text-muted small">No views recorded yet.</div>';
    }
  })();
})();
</script>
{% endblock %}
